<!DOCTYPE html>
<html>
  <head>
    <title>Lasociale - testpage</title>
    <style>
        img { 
          margin-left: auto; 
          margin-right: auto;
          display: block; 
        }
    </style>
    <script>
       var dt = new Date();
       var dtm = dt.getMonth()+1;
       if (dtm<10) dtm = '0' + dtm;
       var dtd = dt.getDate();
       if (dtd <10) dtd = '0' + dtd;
       var now = dt.getFullYear() +'-' + dtm + '-' + dtd;

       function getChecksum(bytes) {
          var n1 = 0;
          var mult = [ 17, 73, 14, 2, 27, 99, 101, 7];
          for(var n =0; n < 8; n++)
          {
             n1 = n1 + (bytes[n] + (bytes[n] * mult[n])) & 0xFFFF;
          }

          return [ (n1 & 0xFF), ((n1>>8)&0xFF)];
       }

       function setChecksum(bytes) {
         var cs = getChecksum(bytes);
         bytes[8] = cs[0];
         bytes[9] = cs[1];
       }

       function checkChecksum(bytes) {
         var cs = getChecksum(bytes);
         return bytes[8] === cs[0] && bytes[9] == cs[1];
       }



       function toHex(bytes) {
         var res = '';
         for(var b=0; b< bytes.length; b++) {
           if (bytes[b] < 0x10)
             res += '0';
           res += bytes[b].toString(16);
         }

         return res;
       }
       function createNonce() {
         var bytes = [];
         for(var b=0; b < 10; b++) {
           for(;;)
           {
             bytes[b] = Math.floor(Math.random() * 256);
             if (bytes[b] !== 0xBA && bytes[b] !== 0x98 && bytes[b] !== 0xDC)
               break;
           }
         }
         bytes[6] = 0xBA;
         setChecksum(bytes);
         return toHex(bytes);
       }

       window.onload = function() {
         var nonce = createNonce();
         console.log(nonce);
         document.getElementById('cont').innerHTML='<img src="/world.svg?nonce='+nonce+'" />';

         connectWS(nonce);
       }


       function connectWS(nonce) {
         var url = 'ws://' + location.hostname + ':3334/';
         var lssocket = new WebSocket(url);
         lssocket.onopen = function(event) {
           lssocket.send(nonce);
         }
         lssocket.onmessage = function (event) {
           var url = '/' + event.data + '.svg';
           document.getElementById('cont').innerHTML='<img src="' + url + '"/>';

             
         }
       }

       
    </script>
  </head>
  <body>
    <div id="cont"></div>
  </body>
</html>

